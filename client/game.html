<link rel="stylesheet" href="css/game.css">

<div data-include="navbar-top"></div>

<div id="actualGame">
  <div id="gameBoard"></div>
  <br/>
  <div id="decks"></div>
  <br/>
</div>

<div id="utilities">
  <button id="returnNextCardButton">Flip next card</button>
</div>

<script>
  function createHtmlCardImg(cardName) {
    return $('<img>', {
      class: 'cardImg',
      src: '/deck/' + cardName + '.png',
      alt: cardName
    });
  }

  function createHtmlCard(card, canReturn = false) {
    var $cardContainer = $('<div>', { class: 'cardContainer' });
    var $card = $('<div>', {
      class: 'card',
      id: card.id
    });
    var $cardFront = $('<div>', { class: 'card__face card__face--front' });
    var $cardBack = $('<div>', { class: 'card__face card__face--back' });

    if (card.name !== 'covered') {
      $frontImg = createHtmlCardImg(card.name);
      $card.addClass('discovered');
      $cardFront.append($frontImg);
    }

    var $backImg = createHtmlCardImg('covered');

    $cardBack.append($backImg);
    $card.append($cardBack);
    $card.append($cardFront);
    $cardContainer.append($card);

    if (canReturn) {
      $cardContainer.click(function() {
        toggleCard(card.id);
      });
      $cardContainer.addClass('clickable');
    } else {
      $cardContainer.addClass('not-allowed');
    }

    return $cardContainer;
  } 
</script>

<script>
  // SOCKET

  var socketProtocol = 'ws';
  if (data.isHttps) {
    socketProtocol = 'wss';
  }
  var s = new WebSocket(socketProtocol + '://' + window.location.host + '/');

  s.addEventListener('error', function (m) {
    console.error('websocket connection error');
  });

  s.addEventListener('open', function (m) {
    s.send(JSON.stringify({ 'message': 'amIOwner' }));
    s.send(JSON.stringify({ 'message': 'needWholeGame' }));
  });

  s.addEventListener('message', function (message) {
    var data = JSON.parse(message.data);
    
    if (typeof data['users'] !== 'undefined') {
      /*
      data['users'].forEach(function(user) {
        // user['nickname'];
      });
      */
    }
    
    if (typeof data['iAmOwner'] !== 'undefined') {
      if (!data['iAmOwner']) {
        $('#returnNextCardButton').prop('title', 'Reserved to game owner');
        $('#returnNextCardButton').addClass('not-allowed');
      }
      $('#returnNextCardButton').prop('disabled', !data['iAmOwner']);
    }

    if (typeof data['decks'] !== 'undefined') {
      var decksHtml = '';
      var isItMe = '';
      var decksHTML = $('#decks');
      decksHTML.empty();
      data['decks'].forEach(function(player) {
        isItMe = (player.yourDeck ? ' (you) ' : '');
        var playerDiv = $('<div>', {class: "playerDiv"});
        playerDiv.append(player.nickname + ': ' + isItMe + '\n<br/>\n');
        player.deck.forEach(function(card) {
          playerDiv.append(createHtmlCard(card, isItMe));
        });
        decksHTML.append(playerDiv);
      });
    }
    
    if (typeof data['gameBoard'] !== 'undefined') {
      var $gameBoard = $('#gameBoard');
      $gameBoard.empty();
      data['gameBoard'].forEach(function(row) {
        var $gameBoardRow = $('<div>', {class: 'gameBoardRow'});
        row.forEach(function(card) {
          $gameBoardRow.append(createHtmlCard(card));
        });
        $gameBoard.append($gameBoardRow);
      });
    }
    
    if (typeof data['updateCard'] !== 'undefined') {
      var $cardDiv = $('#' + data['updateCard'].id);
      var card = data['updateCard'];
      var $cardFace = $cardDiv.find('.card__face.card__face--front');
      if (card.name !== 'covered') {
        $frontImg = createHtmlCardImg(card.name);
        $cardFace.empty();
        $cardFace.append($frontImg);
        $cardDiv.addClass('discovered');
      }
      else {
        $cardDiv.removeClass('discovered');
        setTimeout(function() {
          if (!$cardDiv.hasClass('discovered')) {
            $cardFace.empty();
          }
        }, 1000);
      }
    }

    if (typeof data['message'] !== 'undefined') {
      switch (data['message']) {
        case 'refresh':
          document.location.reload(true);
          break;
        case 'updateReturnCardButon':
          $("#returnNextCardButton").html("Back to wating room")
          break;
        default: 
      };
    }
  });

  function toggleCard(cardId) {
    s.send(JSON.stringify({ 'message': 'returnCardDeck', 'cardId': cardId }));
  }

  $("#leaveRoomButtonId").click(function() {
    s.close();
  });

  $('#returnNextCardButton').click(function() {
    s.send(JSON.stringify({ 'message': 'returnNextCard' }));
  });

</script>
