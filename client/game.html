<style>
  body { background: linear-gradient(0.4turn, #ccffff, #99ffcc); }
</style>

<h3><span id="ownedBy"></span>'s room</h3>

<div id="gameBoard"></div>
<br/>
<div id="decks"></div>
<br/>
<button id="returnNextCardButton">Return next card</button>
<br/>
<br/>
<form action="leaveRoom">
  <input id="leaveRoomButtonId" type="submit" value="Leave"/>
</form>

<div id="users"></div>

<script>
  document.getElementById('ownedBy').innerHTML = data.ownedBy;
</script>

<script>
  function cardImageHTML(card) {
    var img = $('<img>', { 
      id: card.id,
      src: "/deck/" + card.name + ".png",
      height: 88,
      alt: card.name,
      onClick: "toggleCard('" + card.id + "')"
       });
    return img;
  } 
</script>

<script>
  // SOCKET

  var s = new WebSocket('ws://' + window.location.host + '/');

  s.addEventListener('error', function (m) {
    console.error('websocket connection error');
  });

  s.addEventListener('open', function (m) {
    s.send(JSON.stringify({ 'message': 'amIOwner' }));
    s.send(JSON.stringify({ 'message': 'needWholeGame' }));
  });

  s.addEventListener('message', function (message) {
    var data = JSON.parse(message.data);
    
    if (typeof data['users'] !== 'undefined') {
      var usersHtml = '<h4>Players:</h4><ul>';
      data['users'].forEach(function(user) {
        usersHtml += '<li>' + user['nickname'] + '</li>';
      });
      usersHtml += '</ul>'
      $('#users').html(usersHtml);
    }
    
    if (typeof data['iAmOwner'] !== 'undefined') {
      if (!data['iAmOwner']) {
        $('#returnNextCardButton').prop('title', 'Reserved to game owner');
      }
      $('#returnNextCardButton').prop('disabled', !data['iAmOwner']);
    }

    if (typeof data['decks'] !== 'undefined') {
      var decksHtml = '';
      var isItMe = '';
      var decksHTML = $('#decks');
      decksHTML.empty();
      data['decks'].forEach(function(player) {
        isItMe = (player.yourDeck ? ' (you) ' : '');
        decksHTML.append('<hr>');
        decksHTML.append(player.nickname + ': ' + isItMe + '\n<br/>\n');
        player.deck.forEach(function(card) {
          decksHTML.append(cardImageHTML(card));
        });
      });
    }
    
    if (typeof data['gameBoard'] !== 'undefined') {
      var gameBoardHTML = $('#gameBoard');
      gameBoardHTML.empty();
      data['gameBoard'].forEach(function(row) {
        row.forEach(function(card) {
          gameBoardHTML.append(cardImageHTML(card));
        });
        gameBoardHTML.append('<br/>');
      });
    }
    
    if (typeof data['message'] !== 'undefined') {
      switch (data['message']) {
        case 'refresh':
          document.location.reload(true);
          break;
        default: 
      };
    }
  });

  function toggleCard(cardId) {
    s.send(JSON.stringify({ 'message': 'returnCardDeck', 'cardId': cardId }));
  }

  $("#leaveRoomButtonId").click(function() {
    s.close();
  });

  $('#returnNextCardButton').click(function() {
    s.send(JSON.stringify({ 'message': 'returnNextCard' }));
  });

</script>
