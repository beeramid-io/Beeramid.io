<link rel="stylesheet" href="css/waitingRoom.css">

<div data-include="navbar-top"></div>

<div id="waitingTitleDiv">
  <p>Waiting for players...</p>
</div>
<br />
<br />
<br />
<div id="tableContent">
  <div id="users"></div>
  <div id="deckParameterDiv">
    <ul>
      <li>
        <h4>Decks in game:</h4>
        <span id="decksInGame">
          <button class="minusButton" param="decksInGame">-</button>
          <span class="value"></span>
          <button class="plusButton" param="decksInGame">+</button>
        </span>
      </li>
      <li>
        <h4>Cards per player:</h4>
        <span id="cardsPerPlayer">
          <button class="minusButton" param="cardsPerPlayer">-</button>
          <span class="value"></span>
          <button class="plusButton" param="cardsPerPlayer">+</button>
        </span>
      </li>
      <li>
        <h4>Rows in the pyramid:</h4>
        <span id="rowsInThePyramid">
          <button class="minusButton" param="rowsInThePyramid">-</button>
          <span class="value"></span>
          <button class="plusButton" param="rowsInThePyramid">+</button>
        </span>
      </li>
    </ul>
  </div>
</div>
<div id="buttonDiv">
    <button id="runGameButton">Run Game</button>
</div>
<script>
  $('#ownedBy').html(data.ownedBy);
</script>

<script>
  // SOCKET

  var socketProtocol = 'ws';
  if (data.isHttps) {
    socketProtocol = 'wss';
  }
  var s = new WebSocket(socketProtocol + '://' + window.location.host + '/');

  s.addEventListener('error', function (m) { console.log('websocket connection error'); });

  s.addEventListener('open', function (m) {
    console.log('websocket connection opened');
    s.send(JSON.stringify({ 'message': 'amIOwner' }));
  });

  s.addEventListener('message', function (message) {
    var data = JSON.parse(message.data);
    
    if (typeof data['users'] !== 'undefined') {
      var usersHtml = '<h4>Players:</h4><ul>';
      data['users'].forEach(function(user) {
        usersHtml += '<li>' + user['nickname'] + '</li>';
      });
      usersHtml += '</ul>'
      $('#users').html(usersHtml);
    }

    if (typeof data['gameParams'] !== 'undefined') {
      $('#decksInGame .value').html(data['gameParams']['decksInGame']);
      $('#cardsPerPlayer .value').html(data['gameParams']['cardsPerPlayer']);
      $('#rowsInThePyramid .value').html(data['gameParams']['rowsInThePyramid']);
    }
    
    if (typeof data['iAmOwner'] !== 'undefined') {
      if (!data['iAmOwner']) {
        $('.minusButton, .plusButton, #runGameButton').prop('title', 'Reserved to game owner');
      }
      $('.minusButton, .plusButton, #runGameButton').prop('disabled', !data['iAmOwner']);
    }
    
    if (typeof data['message'] !== 'undefined') {
      switch (data['message']) {
        case 'refresh':
          document.location.reload(true);
          break;
        default: 
      };
    }
  });

  $("#leaveRoomButton").click(function () {
    s.close();
  });

  $('#runGameButton').click(function () {
    s.send(JSON.stringify({ 'message': 'runGame' }));
  });

  $('.minusButton').click(function () {
    var param = $(this).attr('param');
    s.send(JSON.stringify({
      'addToGameParameter': {
        'param': param,
        'value': -1
      }
    }));
  });

  $('.plusButton').click(function () {
    var param = $(this).attr('param');
    s.send(JSON.stringify({
      'addToGameParameter': {
        'param': param,
        'value': 1
      }
    }));
  });

</script>